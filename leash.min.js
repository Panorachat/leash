/**@license
 *  This file is part of Leash (Browser Shell)
 *  Copyright (c) 2013-2017 Jakub Jankiewicz <http://jcubic.pl/me>
 *
 *  Released under the MIT license
 *
 *  Date: Wed, 27 Dec 2017 14:11:10 +0000
 */
function Uploader(e){this.token=e.terminal.token();this.leash=e}Uploader.prototype.upload_tree=function e(n,r){var t=$.Deferred();var i=this;r=r||i.leash.cwd;function a(e,n){e=e.slice();(function r(){var i=e.shift();if(i){n(i).then(r).fail(function(){t.reject()})}else{t.resolve()}})()}function o(e){a(e,function(e){return i.upload_tree(e,r+"/"+n.name)})}function s(e){i.upload(e,r).then(function(){t.resolve()}).fail(function(){t.reject()})}if(typeof Directory!="undefined"&&n instanceof Directory){n.getFilesAndDirectories().then(function(e){o(e)})}else if(typeof File!="undefined"&&n instanceof File){s(n)}else if(n.isFile){n.file(s)}else if(n.isDirectory){var c=n.createReader();c.readEntries(function(e){o(e)})}return t.promise()};Uploader.prototype.upload=function e(n,r){var t=this;var i=$.Deferred();var a=r+"/"+n.name;if(n.size>t.leash.settings.upload_max_filesize){if(!(n.slice||n.webkitSlice)){t.leash.terminal.error("Exceeded filesize limit.");i.resolve();t.leash.animation.stop()}else{t.maybe_ask(a).then(function(){t.leash.animation.start(400);t.upload_by_chunks(n,r).then(function(){i.resolve();t.leash.animation.stop()}).fail(function(){i.reject();t.leash.animation.stop()})}).fail(function(){i.resolve();t.leash.animation.stop()})}}else{t.maybe_ask(a).then(function(){t.upload_file(n,r).then(function(){i.resolve();t.leash.animation.stop()}).fail(function(){i.reject();t.leash.animation.stop()})}).fail(function(){i.resolve();t.leash.animation.stop()})}return i.promise()};Uploader.prototype.upload_by_chunks=function e(n,r,t){var i=this;t=t||1048576;var a=$.Deferred();function o(e,r){if(n.slice){return n.slice(e,r)}else if(n.webkitSlice){return n.webkitSlice(e,r)}}var s=0;function c(e,s){if(e<n.size){var f=o(e,s);var l=new FormData;l.append("file",f,n.name);l.append("token",i.token);l.append("path",r);$.ajax({url:"lib/upload.php?append=1",type:"POST",success:function(e){if(e.error){i.leash.terminal.error(e.error);a.reject()}else{c(s,s+t)}},error:function(e,n,r){i.leash.terminal.error(e.statusText);a.reject()},data:l,cache:false,contentType:false,processData:false})}else{i.leash.terminal.echo('File "'+n.name+'" uploaded.');a.resolve()}}var f=r+"/"+n.name;this.leash.service.unlink(i.token,f)(function(e,n){if(e){i.leash.terminal.error(e.message);a.reject()}else{c(0,t)}});return a.promise()};Uploader.prototype.maybe_ask=function e(n){var r=this;var t=$.Deferred();if(r.answer){t.resolve()}else{r.leash.service.file_exists(n)(function(e,i){if(i){var a='File "'+n+'" exis'+"ts do you want to overwrite it (Y/N/A)? ";r.leash.terminal.history().disable();r.leash.terminal.push(function(e){if(e.match(/^(y|n|a)$/i)){r.leash.terminal.pop().history().enable();if(e.match(/^a$/i)){t.resolve();r.answer=true}else if(e.match(/^y$/i)){t.resolve()}else if(e.match(/^n$/i)){t.reject()}}},{prompt:a})}else{t.resolve()}})}return t.promise()};Uploader.prototype.upload_file=function e(n,r){var t=this;var i=$.Deferred();var a=new FormData;a.append("file",n);a.append("token",t.token);a.append("path",r);$.ajax({url:"lib/upload.php",type:"POST",success:function(e){t.leash.animation.stop();if(e.error){t.leash.terminal.error(e.error);i.reject()}else{t.leash.terminal.echo('File "'+n.name+'" '+"uploaded.");i.resolve()}},error:function(e,n,r){t.leash.terminal.error(e.statusText);i.reject()},data:a,cache:false,contentType:false,processData:false});return i.promise()};var leash=function(){var e=$.omap({blue:"#55f",green:"#4d4",grey:"#999"},function(e,n){return function(e,r){return"[["+(r||"")+";"+n+";]"+e+"]"}});var n=["Copyright (c) 2013-2017 Jakub Jankiewicz <http://jcubic.pl/me>","","Licensed under MIT license"].map(function(e){return e===""?e:"  "+e}).join("\n");function r(e,n,t){if(n>e.length){return r(t+e,n,t)}else{return e}}function t(e){var n=[];$.each(e,function(e,r){n.push(r);n.push(r.toLowerCase())});return n}function i(){var e=["ACCESSIBLE","ADD","ALL","ALTER","ANALYZE","AND","AS","ASC","ASENSITIVE","BEFORE","BETWEEN","BIGINT","BINARY","BLOB","BOTH","BY","CALL","CASCADE","CASE","CHANGE","CHAR","CHARACTER","CHECK","COLLATE","COLUMN","CONDITION","CONSTRAINT","CONTINUE","CONVERT","CREATE","CROSS","CURRENT_DATE","CURRENT_TIME","CURRENT_TIMESTAMP","CURRENT_USER","CURSOR","DATABASE","DATABASES","DAY_HOUR","DAY_MICROSECOND","DAY_MINUTE","DAY_SECOND","DEC","DECIMAL","DECLARE","DEFAULT","DELAYED","DELETE","DESC","DESCRIBE","DETERMINISTIC","DISTINCT","DISTINCTROW","DIV","DOUBLE","DROP","DUAL","EACH","ELSE","ELSEIF","ENCLOSED","ESCAPED","EXISTS","EXIT","EXPLAIN","FALSE","FETCH","FLOAT","FLOAT4","FLOAT8","FOR","FORCE","FOREIGN","FROM","FULLTEXT","GRANT","GROUP","HAVING","HIGH_PRIORITY","HOUR_MICROSECOND","HOUR_MINUTE","HOUR_SECOND","IF","IGNORE","IN","INDEX","INFILE","INNER","INOUT","INSENSITIVE","INSERT","INT","INT1","INT2","INT3","INT4","INT8","INTEGER","INTERVAL","INTO","IS","ITERATE","JOIN","KEY","KEYS","KILL","LEADING","LEAVE","LEFT","LIKE","LIMIT","LINEAR","LINES","LOAD","LOCALTIME","LOCALTIMESTAMP","LOCK","LONG","LONGBLOB","LONGTEXT","LOOP","LOW_PRIORITY","MASTER_SSL_VERIFY_SERVER_CERT","MATCH","MEDIUMBLOB","MEDIUMINT","MEDIUMTEXT","MIDDLEINT","MINUTE_MICROSECOND","MINUTE_SECOND","MOD","MODIFIES","NATURAL","NOT","NO_WRITE_TO_BINLOG","NULL","NUMERIC","ON","OPTIMIZE","OPTION","OPTIONALLY","OR","ORDER","OUT","OUTER","OUTFILE","PRECISION","PRIMARY","PROCEDURE","PURGE","RANGE","READ","READS","READ_WRITE","REAL","REFERENCES","REGEXP","RELEASE","RENAME","REPEAT","REPLACE","REQUIRE","RESTRICT","RETURN","REVOKE","RIGHT","RLIKE","SCHEMA","SCHEMAS","SECOND_MICROSECOND","SELECT","SENSITIVE","SEPARATOR","SET","SHOW","SMALLINT","SPATIAL","SPECIFIC","SQL","SQLEXCEPTION","SQLSTATE","SQLWARNING","SQL_BIG_RESULT","SQL_CALC_FOUND_ROWS","SQL_SMALL_RESULT","SSL","STARTING","STRAIGHT_JOIN","TABLE","TERMINATED","THEN","TINYBLOB","TINYINT","TINYTEXT","TO","TRAILING","TRIGGER","TRUE","UNDO","UNION","UNIQUE","UNLOCK","UNSIGNED","UPDATE","USAGE","USE","USING","UTC_DATE","UTC_TIME","UTC_TIMESTAMP","VALUES","VARBINARY","VARCHAR","VARCHARACTER","VARYING","WHEN","WHERE","WHILE","WITH","WRITE","XOR","YEAR_MONTH","ZEROFILL"];return t(e)}function a(){var e=["ABORT","ACTION","ADD","AFTER","ALL","ALTER","ANALYZE","AND","AS","ASC","ATTACH","AUTOINCREMENT","BEFORE","BEGIN","BETWEEN","BY","CASCADE","CASE","CAST","CHECK","COLLATE","COLUMN","COMMIT","CONFLICT","CONSTRAINT","CREATE","CROSS","CURRENT_DATE","CURRENT_TIME","CURRENT_TIMESTAMP","DATABASE","DEFAULT","DEFERRABLE","DEFERRED","DELETE","DESC","DETACH","DISTINCT","DROP","EACH","ELSE","END","ESCAPE","EXCEPT","EXCLUSIVE","EXISTS","EXPLAIN","FAIL","FOR","FOREIGN","FROM","FULL","GLOB","GROUP","HAVING","IF","IGNORE","IMMEDIATE","IN","INDEX","INDEXED","INITIALLY","INNER","INSERT","INSTEAD","INTERSECT","INTO","IS","ISNULL","JOIN","KEY","LEFT","LIKE","LIMIT","MATCH","NATURAL","NO","NOT","NOTNULL","NULL","OF","OFFSET","ON","OR","ORDER","OUTER","PLAN","PRAGMA","PRIMARY","QUERY","RAISE","RECURSIVE","REFERENCES","REGEXP","REINDEX","RELEASE","RENAME","REPLACE","RESTRICT","RIGHT","ROLLBACK","ROW","SAVEPOINT","SELECT","SET","TABLE","TEMP","TEMPORARY","THEN","TO","TRANSACTION","TRIGGER","UNION","UNIQUE","UPDATE","USING","VACUUM","VALUES","VIEW","VIRTUAL","WHEN","WHERE","WITH","WITHOUT"];return t(e)}function o(e,n,r){var t=new RegExp("^"+n.map($.terminal.escape_regex).join("|")+"$","i");return function(n){return n.split(/((?:\s|&nbsp;|\)|\()+)/).map(function(n){if(e.indexOf(n)!=-1){return"[[b;"+r+";]"+n+"]"}else if(n.match(t)){return"[[u;;]"+n+"]"}else{return n}}).join("")}}function s(e,n,r){function t(n,r){var t=$.terminal.escape_brackets("[AJAX] "+r+" server response\n"+n.responseText);e.error(t);l(e)}function i(n){if(typeof n=="string"){e.error(n)}else{if(n.message){e.echo(n.message)}if(n.error.traceback){e.echo(n.error.traceback)}}}function a(r,a,o){if(a===undefined){a=[]}f(e);$.jrpc(n,r,a,function(n){if(n.error){i(n.error)}else if(n.result){if(o===undefined||o){e.echo(n.result.replace(/\n$/,""))}}l(e)},t)}f(e);var o;$.jrpc(n,"start",[],function(t){if(t.error){i(t.error);l(e)}else if(t.result){o=t.result;e.echo("[[b;#F8B612;]Warring: each time you execute a c"+"ommand, python will execute all your previous c"+"ommands, so watch out on commands that can be e"+"xecuted only once]");$.jrpc(n,"info",[],function(n){if(n.error){i(n.error)}else{e.echo(n.result)}r({evaluate:function(e){a("evaluate",[o,e])},destroy:function(){a("destroy",[o])}});l(e)})}},t)}function c(n,r,t){var i=e.green(n+"&#64;"+r);var a=e.grey(n==="root"?"# ":"$ ");return i+e.grey(":")+e.blue(t)+a}function f(e){e.pause(true).find(".prompt").hidden()}function l(e){e.resume().find(".prompt").visible()}function u(r,t,u){var p;var h;var d=$.terminal.defaults.formatters;var v=[d];var g=[];var E=[];function T(e){var n=e;$.each(y.env,function(e,r){n=n.replace("$"+e,r)});return n}function R(e,n){if(e){I(e)}else{switch($.type(n)){case"array":if(n.length){var r=Object.keys(n[0]);n=[r].concat(n.map(function(e){if(e instanceof Array){return e.map(function(e){return $.terminal.escape_brackets(String(e))})}else{return Object.keys(e).map(function(n){return $.terminal.escape_brackets(String(e[n]))})}}));y.terminal.echo(A(n,true),{formatters:false})}break;case"number":y.terminal.echo("Query OK, "+n+" row affected")}}l(y.terminal)}function I(e){if(e.error){y.terminal.error(e.error.message);y.terminal.error("in "+e.error.file+" at line "+e.error.at);y.terminal.error(e.error.line)}else{y.terminal.error(e.message)}}function A(e,n){if(!e.length){return""}for(var r=e.length-1;r>=0;r--){var t=e[r];var i=[];for(var a=0;a<t.length;a++){var o=t[a].toString().split("\n");t[a]=o.shift();i.push(o)}var s=Math.max.apply(Math,i.map(function(e){return e.length}));for(var c=s-1;c>=0;c--){e.splice(r+1,0,i.map(function(e){return e[c]||""}))}}var f=e[0].map(function(n,r){var t=e.map(function(e){if(e[r]!=undefined){var n=wcwidth(e[r]);if(e[r].match(/\t/g)){n+=e[r].match(/\t/g).length*3}return n}else{return 0}});return Math.max.apply(Math,t)});e=e.map(function(e){return"| "+e.map(function(e,n){var r=wcwidth(e);if(e.match(/\t/g)){r+=e.match(/\t/g).length*3}if(r<f[n]){e+=new Array(f[n]-r+1).join(" ")}return e}).join(" | ")+" |"});var l="+"+f.map(function(e){return new Array(e+3).join("-")}).join("+")+"+";if(n){return l+"\n"+e[0]+"\n"+l+"\n"+e.slice(1).join("\n")+"\n"+l}else{return l+"\n"+e.join("\n")+"\n"+l}}var w=[];var _=[];function N(e){return function(n,t,i){var a=e+" "+n.args[0];f(i);r.shell(t,a,y.cwd)(function(e,n){if(e){I(e)}else{y.less($.terminal.escape_brackets(n.output))}l(i)})}}var y={formatters:d,version:"0.17.0",date:"Wed, 27 Dec 2017 14:11:10 +0000",jargon:[],dirs:{},env:{},banner:function(){var e="";if(!y.version.match(/\{{2}VERSION\}{2}/)){e=" v. "+y.version}var n="";if(!y.date.match(/\{{2}DATE\}{2}/)){n="build at: "+y.date}var r=["   __   _______   ______ __","  / /  / __/ _ | / __/ // /"," / /__/ _// __ |_\\ \\/ _  /","/____/___/_/ |_/___/_//_/"+e];if(n){r.push(n)}r.push("");return r.join("\n")},animation:{animating:false,start:function(e){var n=["/","-","\\","|"],r=0;this.animating=true;this.prompt=y.terminal.get_prompt();var t=this;y.terminal.pause(true);(function i(){y.terminal.set_prompt(n[r++]);if(r>n.length-1){r=0}t.timer=setTimeout(i,e)})()},stop:function(){if(this.animating){clearTimeout(this.timer);y.terminal.set_prompt(this.prompt);this.animating=false}l(y.terminal)}},service:r,init:function(e){e.on("click",".jargon",function(){var n="jargon "+$(this).data("text").replace(/\s/g," ");e.exec(n).then(function(){if(e.settings().historyState){e.save_state(n)}})}).on("click",".exec",function(){var n=$(this).data("text");e.exec(n).then(function(){if(e.settings().historyState){e.save_state(n)}})}).on("click",".wiki",function(){var n=$(this).data("text").replace(/\s/g," ");var r=$.terminal.split_command("wikipedia "+n);y.commands.wikipedia(r,e.token(),e)}).on("click",".rfc",function(){var n=$(this).data("text");var r=$.terminal.split_command("rfc "+n);y.commands.rfc(r,e.token(),e)}).on("click","a",function(n){if($(this).parents().is(".exception")){return}if(!n.ctrlKey){var r=e.token();var t=$(this).attr("href").trim();if(t.match(/^mailto:/)){return}y.less(function(e,n){y.service.html(r,t,e-1)(function(e,r){if(!e){n(r.trim().split("\n"))}})});return false}});if(!y.installed){y.install(e)}else{y.config(e)}},interpreter:function(e,n){if(!g.length){n.error("Not interpeter")}else{g[g.length-1](e,n)}},make_interpreter:function(e){return function(n,r){if(!y.installed){r.error("Invalid command, you need to refresh the p"+"age")}else{if($.terminal.unclosed_strings(n)){y.shell(n,e,r)}else{var t=$.terminal.parse_command(n);if(y.commands[t.name]){y.commands[t.name](t,e,r)}else if(n!==""){y.shell(n,e,r)}}}}},install:function(e){var n={};var t=[{name:"root_password",prompt:"root password: ",mask:true},{name:"server",text:"Type your server name"},{name:"username",text:"Your normal username"},{name:"home",text:"Home directory"},{name:"guest",text:"Allow guest sessions (Y)es/(N)o",boolean:true},{name:"sudo",text:"Execute sudo for user accounts (Y)es/(N)o",boolean:true},{name:"password",mask:true}];e.echo("[[;#C78100;]You are running Leash for the first"+" time. You need to configure it]\n");e.history().disable();(function r(i,a){var o=t[i];if(o){if(o.text){e.echo("[[b;#fff;]"+o.text+"]")}e.push(function(t){e.pop();if(o.mask){e.set_mask(false)}if(o.boolean){var s;if(t.match(/^Y(es)?/i)){s=true}else if(t.match(/^N(o)?/i)){s=false}if(typeof s!="undefined"){n[o.name]=s;r(i+1,a)}}else{n[o.name]=t;r(i+1,a)}},{prompt:o.prompt||o.name+": "});if(o.mask){e.set_mask(true)}}else{a()}})(0,function(){f(e);var t=$.terminal.ansi_colors.bold;function i(a,o){if(a.length){var s=a[0];var c=a.slice(1);var f="Test Shell '"+s+"' ";r.test_shell(null,s)(function(r,a){if(a){f+="&#91;[[b;"+t.green+";]PASS]&#93;"}else{f+="&#91;[[b;"+t.red+";]FAIL]&#93;"}e.echo(f);if(a){e.echo("Using shell "+s);n.shell=s;o()}else{i(c,o)}})}else{e.error("Not valid shell found");e.error("You will not able to use Leash ful"+"ly");n.shell=null;o()}}e.echo("Detect Shell");r.list_shells(null)(function(t,a){i(a,function(){r.configure(n)(function(n){l(e);if(n){e.error(n.message);y.install(e)}else{e.echo("Your instalation is complete no"+"w you can refresh the page and "+"login")}})})})})},config:function(e){var n=e.token();if(n){f(e);r.valid_token(n)(function(t,i){if(!i){e.set_token(undefined);e.logout();l(e)}else{y.token=n;y.env.TOKEN=n;g.push(y.make_interpreter(n));r.jargon_list()(function(e,n){if(!e){y.jargon=n}});r.get_settings(n)(function(t,i){if(t){I(t);l(e);return}y.settings=h=i;y.cwd=h.home;if(i.show_messages!==false){var a=i.messages||[];e.echo(a.map(function(e){return"[[;#ff0;]"+e+"]"}).join("\n"))}r.dir(n,y.cwd)(function(n,r){y.dir=r;e.set_prompt(y.prompt);setTimeout(function(){l(e)},100)});if(h.purgeOnUnload){$(window).unload(function(){e.purge()})}})}})}},refresh_dir:function(e){r.dir(y.token,y.cwd)(function(n,r){y.dir=r;if($.isFunction(e)){e()}})},shell:function(e,n,t){var i=/\|\s*less\s*$/;var a=$.Deferred();e=T(e);f(t);if(e.match(i)){e=e.replace(i,"");r.shell(n,e,y.cwd)(function(e,n){if(e){I(e)}else{y.less(n.output)}l(t);a.resolve()})}else{r.shell(n,e,y.cwd)(function(e,n){if(e){I(e);l(t)}else{if(n.output){var r=/\n(\x1b\[m)?$/;var i=n.output.replace(r,"").replace(/\[\[/g,"&#91;&#91;").replace(/\]\]/g,"&#93;&#93;");t.echo(i)}y.cwd=n.cwd;y.refresh_dir(function(){l(t);a.resolve()})}})}return a.promise()},wikipedia:function(e,n){function r(e){if(e.length==1){return e[0]}else if(e.length==2){return e.join(" and ")}else if(e.length>2){return e.slice(0,e.length-1).join(", ")+" and "+e[e.length-1]}}function t(e){return r(e.split("|").map(function(e){if(e.match(/^\s*.*\s*=/)){return""}else{return"[[bu;#fff;;wiki;]"+e+"]"}}).filter(function(e){return!!e}))}function i(e,n,r){var t=/\[\[([^\]]+)\]\]/;if(e.match()){return e.split(/(\[\[[^\]]+\]\])/).map(function(e){var r=e.match(t);if(r){return"[[bu;"+n+";;wiki]"+r[1]+"]"}else{return"[[;"+n+";]"+e+"]"}}).join("")}else{return"[[;"+n+";]"+(e||r)+"]"}}var a={main:function(e){return"Main Article: "+t(e)+"\n"},dunno:function(){return"?"},yes:function(e){return i(e,"#0f0","yes")},no:function(e){return i(e,"#f00","no")},partial:function(e){return i(e,"#ff0","partial")},"lang-ar":function(e){return"[[bu;#fff;;;Arabic_language]Arabic]: "+e},"(?:IPAc-en|IPA-en)":function(e){if(!e.match(/\|/)){return"English pronunciation: /"+e+"/"}var n={tS:"tʃ",dZ:"dʒ","J\\":"ɟ","p\\":"ɸ",B:"β",T:"θ",D:"ð",S:"ʃ",Z:"ʒ",C:"ç","j\\ (jj)":"ʝ",G:"ɣ","X\\":"ħ","?\\":"ʕ","h\\":"ɦ",F:"ɱ",J:"ɲ",N:"ŋ","4 (r)":"ɾ","r (rr)":"r","r\\":"ɹ",R:"ʀ",P:"ʋ",H:"ɥ",I:"ɪ",E:"ɛ","{":"æ",2:"ø",9:"œ",1:"i","@":"ə",6:"ɐ",3:"ɜ","}":"ʉ",8:"ɵ","&":"ɶ",M:"ɯ",7:"ɤ",V:"ʌ",A:"ɑ",U:"ʊ",O:"ɔ",Q:"ɒ",",":"ˌ","'":"ˈ",_:"ː"};var r={};var t="/"+e.split("|").map(function(e){if(!e.match(/^\s*-\s*$|^\s*en-us/)){var t=/^\s*(us|lang|pron|audio)\s*=?\s*(.*)/i;var i=e.match(t);if(i){r[i[1].toLowerCase().trim()]=i[2]||true}else{Object.keys(n).forEach(function(r){e=e.replace(r,n[r])});return e}}}).filter(Boolean).join("")+"/";t="[[bu;#fff;;wiki;Help:IPA for English]"+t+"]";if(r.pron){t="pronunciation: "+t}if(r.lang){t="English "+t}if(r.us){t="US "+t}return t},"quote box":function(e){var n=e.match(/\s*quote\s*=\s*("[^"]+"|[^|]+)/)[1];var r=/'''([^']+(?:'[^']+)*)'''/g;n=n.replace(r,function(e,n){return"][[bi;#fff;]"+n+"][[i;;]"}).replace(/''([^']+(?:'[^']+)*)''/g,"$1").replace(/\[\[([^\]]+)\]\]/g,function(e,n){n=n.split("|");if(n.length==1){return"][[bui;#fff;;wiki]"+n[0]+"][[i;;]"}else{return"][[bui;#fff;;wiki;"+n[0]+"]"+n[1]+"][[i;;]"}});var t=e.match(/\s*source\s*=\s*([^|]+)/)[1].replace(/^(—|-)/,"").trim();return"[[i;;]"+n+"]\n-- "+t},quote:function(e){e=e.replace(/^\s*\|/gm,"").split(/\|(?![^\]]+\])/);var n={};e=e.map(function(e){var r=e.match(/\s*(\w+)\s*=\s*(.*)/);if(r){if(!isNaN(+r[1])){return r[2]}else{n[r[1].toLowerCase()]=r[2];return""}}else{return e}}).join("");var r="";if(n.author){r=n.author}else if(e.match(/^ /m)){r=e.match(/^ (.*)/m)[1]}return"[[i;;]"+e.replace(/'''([^']+(?:'[^']+)*)'''/g,function(e,n){return"][[bi;#fff;]"+n+"][[i;;]"}).replace(/''([^']+(?:'[^']+)*)''/g,"$1").replace(/\[\[([^\]]+)\]\]/g,function(e,n){n=n.split("|");if(n.length==1){return"][[bui;#fff;;wiki]"+n+"][[i;;]"}else{return"][[bui;#fff;;wiki;"+n[0]+"]"+n[1]+"][[i;;]"}})+"]"+(r?"\n-- "+r:"")},"Cat main":function(e){return"The main article for this [[bu;#fff;;wiki"+";Help:category]Category] is [[bu;#fff;;wiki]"+e+"]\n"},"see also":function(e){return"See also "+t(e)+"\n"},tag:function(e){return o("<"+e+">...</"+e+">")},"(?:official website|official)":function(e){if(!e.match(/^http:/)){e="http://"+e}return"[[!;;;;"+e+"]Official Website]"},"IMDb name":function(e){if(n){var r=e.match(/id\s*=\s*([^|]+)/);var t;if(r){t=r[1]}else{t=e}var i="http://www.imdb.com/name/nm"+t;return"[[!;;;;"+i+"]"+n+"] "+"at the [[Internet Movie Database]]"}},"(?:tlx|tl)":function(e){e=e.split("|");var n="";if(e.length>1){n="|"+e.slice(1).join("|")}return o("{{")+"[[bu;#fff;;wiki;Template:"+e[0]+"]"+e[0]+"]"+n+o("}}")},"(?:as of|Asof)":function(e){e=e.split("|");var n=["January","February","March","April","May","June","July","August","September","October","November","December"];var r=[];var t={};for(var i=0;i<e.length;++i){var a=e[i].match(/(\w+)\s*=\s*(\w+)/);if(a){t[a[1].toLowerCase()]=a[2]}else{r.push(e[i])}}var o="As of ";if(t.since){o="Since "}if(t.lc=="y"){o=o.toLowerCase()}if(t.df&&t.df.toLowerCase()=="us"){return o+(r[1]?n[r[1]-1]+" ":"")+(r[2]?r[2]+", ":"")+r[0]}else{return o+(r[2]?r[2]+" ":"")+(r[1]?n[r[1]-1]+" ":"")+r[0]}}};function o(e){var n={"{":"&#123;","}":"&#125;","[":"&#91;","]":"&#93;","<":"&#60;",">":"&#62;","'":"&#39;"};Object.keys(n).forEach(function(r){e=e.replace(new RegExp("\\"+r,"g"),n[r])});return e}e=e.replace(/&nbsp;/g," ").replace(/^\s*;\s*([^:]+):\s*/gm,function(e,n){return"\n"+n+"\n\n"}).replace(/&/g,"&amp;").replace(/^\s*(=+)\s*([^=]+)\s*\1/gm,function(e,e,n){n=n.replace(/''([^']+)''/g,function(e,n){return"][[bi;#fff;]"+n+"][[b;#fff;]"});return"\n[[b;#fff;]"+n+"]\n"}).replace(/\[\.\.\.\]/g,"...").replace(/<code><pre>(.*?)<\/pre><\/code>/g,function(e,n){return o(n)}).replace(/\[\[(?=<nowki\s*\/>)/,function(e){return o(e)}).replace(/{{Cite([^}]+)}}(?![\s\n]*<\/ref>)/gi,function(e,n){var r=n.match(/title\s*=\s*([^|]+)/i);var t=n.match(/url\s*=\s*([^|]+)/i);if(r){if(t){return"[[!;;;;"+t[1].trim()+"]"+r[1].trim()+"]"}else{return r[1].trim()}}else{return""}}).replace(/<nowiki>([\s\S]*?)<\/nowiki>/g,function(e,n){return o(n)});var s=[/<ref[^>]*\/>/g,/<ref[^>]*>[\s\S]*?<\/ref>/g,/\[\[(file|image):[^[\]]*(?:\[\[[^[\]]*]][^[\]]*)*]]/gi,/<!--[\s\S]*?-->/g,/<gallery>[\s\S]*?<\/galery>/g];s.forEach(function(n){e=e.replace(n,"")});var c;for(var f in a){c=new RegExp("{{"+f+"\\|?(.*?)}}","gi");e=e.replace(c,function(e,n){return a[f](n)||""})}c=/{{[^{}]*(?:{(?!{)[^{}]*|}(?!})[^{}]*)*}}/g;do{var l=0;e=e.replace(c,function(e){l++;return""})}while(l);var u=/\[\[([!gbiuso]*);([^;]*)(;[^\]]*\])/i;function p(e,n){var r=/(\[\[[!gbiuso]*;[^;]*;[^\]]*\](?:[^\]]*\\\][^\]]*|[^\]]*|[^\[]*\[[^\]]*)\]?)/i;return function(t,i){return i.split(r).map(function(r){function t(r,t,i,a){return"[["+e+t+";"+(n||i)+a}if($.terminal.is_formatting(r)){return r.replace(u,t)}else{return"[["+e+";"+(n||"")+";]"+r+"]"}}).join("")}}e=e.replace(/\[\[([^\]]+)\]\]/g,function(e,n){if(e.match(u)){return e}if(e.match(/<nowiki[^>]*>/)){return $.terminal.escape_brackets(e)}n=n.replace(/^:(Category)/i,"$1").split("|");var r;if(n.length==1){r="[[bu;#fff;;wiki]"+n[0]+"]"}else{n[1]=n[1].replace(/''([^']+)''/gm,function(e,r){return"][[bui;#fff;;wiki;"+n[0]+"]"+r+"]"+"[[bu;#fff;;wiki;"+n[0]+"]"});r="[[bu;#fff;;wiki;"+n[0]+"]"+n[1]+"]"}return r}).replace(/'''([^']+(?:'[^']+)*)'''/g,p("b","#fff")).replace(/^(\n\s*)*/,"").replace(/([^[])\[(\s*(?:http|ftp)[^\[ ]+) ([^\]]+)\]/g,function(e,n,r,t){function i(e,n){return"][[!i;;;;"+r+"]"+n+"][[!;;;;"+r+"]"}t=t.replace(/'''([^']*(?:'[^']+)*)'''/g,"$1").replace(/''([^']*(?:'[^']+)*)''/g,i);return n+"[[!;;;;"+r+"]"+t+"]"}).replace(/<blockquote>([\s\S]*?)<\/blockquote>/g,p("i")).replace(/''([^']+(?:'[^']+)*)''/g,p("i")).replace(/{\|.*\n([\s\S]*?)\|}/g,function(e,n){var r=/\|\+(.*)\n/;var t;var i=n.match(r);if(i){var a=i[1].trim().replace(/\[\[([^;]+)(;[^\]]+\][^\]]+\])/g,function(e,n,r){return"][["+n+"i"+r+"[[i;;]"})}n=n.replace(/^.*\n/,"").replace(r,"").split(/\|\-.*\n/);if(n.length==1){t=false;n=n[0].replace(/[\n\s]*$/,"").split(/\n/).map(function(e){return[e]})}else{if(n[0].match(/^!|\n!/)){t=true}n=n.map(function(e){var n=/^[|!]|\n[|!]|\|\|/;if(e.match(n)){return e.split(n).map(function(e){return e.replace(/\n/g,"").trim()}).filter(function(e,n){return n!==0})}else{return[]}}).filter(function(e){return e.length})}var o="";if(a){o="\n[[i;;]"+a+"\n"}o+=A(n,t);return o}).replace(/#(REDIRECT)/i,"&#35;$1").replace(/(^\*.*(\n|$))+/gm,function(e){return"\n"+e}).replace(/(^#.*(\n|$))+/gm,function(e){e=e.split(/^#\s*/m).slice(1);return"\n"+e.map(function(n,r){return(e.length>9&&r<9?" ":"")+(r+1)+". "+n}).join("")+"\n"}).split(/(<pre[^>]*>[\s\S]*?<\/pre>)/).map(function(e,n){var r=e.match(/<pre[^>]*>([\s\S]*?)<\/pre>/);var t=/([^\n])\n(?![\n*|+]|\s*[0-9]|:|--|\[\[bu;#fff;;wiki\]Category)/gi;if(r){return r[1]}else{return e.replace(t,"$1 ").replace(/ +/g," ")}}).join("").replace(/<[^>]+>/gm,"").replace(/\n{3,}/g,"\n\n").replace(/\*(\S)/g,"* $1");return e},less:function(e,n){var r=y.terminal;var t=r.export_view();var i,a;var o=0;var s;var c;var f;var l=0;function u(){r.clear();if(c.length-o>a-1){f=":"}else{f="[[;;;inverted](END)]"}r.set_prompt(f);var e=c.slice(o,o+a-1);var n=/^(\[\[[!gbiuso]*;[^;]*;[^\]]*\])/i;e=e.map(function(e,n){return $.terminal.substring(e,l,l+i-1)});if(e.length<a-1){while(a-1>e.length){e.push("~")}}r.echo(e.join("\n"))}function p(){r.pop().import_view(t);if($.isFunction(n)){n()}}function m(){i=r.cols();a=r.rows();if($.isFunction(e)){e(i,function(e){s=e;c=s.slice();u()})}else{s=e.split("\n");c=s.slice();u()}}m();var h=3;var d=false,v,g;function E(e,n){var t=$.terminal.escape_brackets(g),i=g.toLowerCase()==g?"i":"",a=new RegExp("^("+t+")",i),l=new RegExp(t,i),p=-1,m="",h=false,d=false;c=s.slice();if(n){p=o=0}for(var v=0;v<c.length;++v){var E=c[v];for(var T=0,R=E.length;T<R;++T){if(E[T]==="["&&E[T+1]==="["){h=true;d=false;e=T}else if(h&&E[T]==="]"){if(d){h=false;d=false}else{d=true;m=E.substring(e,T+1)}}else if(h&&d||!h){if(E.substring(T).match(a)){var I;if(h&&d){I="][[;;;inverted]$1]"+m}else{I="[[;;;inverted]$1]"}E=E.substring(0,T)+E.substring(T).replace(a,I);T+=I.length-2;if(v>o&&p===-1){p=o=v}}}}c[v]=E}u();r.set_command("");r.set_prompt(f);return p}r.push($.noop,{resize:m,mousewheel:function(e,n){if(n>0){o-=h;if(o<0){o=0}}else{o+=h;if(o-1>c.length-a){o=c.length-a+1}}u();return false},name:"less",keydown:function(e){var n=r.get_command();if(r.get_prompt()!=="/"){if(e.which==191){r.set_prompt("/")}else if(d&&$.inArray(e.which,[78,80])!=-1){if(e.which==78){if(v!=-1){v=E(v+1)}}else if(e.which==80){v=E(0,true)}}else if(e.which==81){p()}else if(e.which==39){l+=Math.round(i/2);u()}else if(e.which==37){l-=Math.round(i/2);if(l<0){l=0}u()}else{if(c.length>a){if(e.which===38){if(o>0){--o;u()}}else if(e.which===40){if(o<=c.length-a){++o;u()}}else if(e.which===34){o+=a;if(o>c.length-a+1){o=c.length-a+1}u()}else if(e.which===33){o-=a;if(o<0){o=0}u()}}}if(!e.ctrlKey&&!e.alKey){return false}}else{if(e.which===8&&n===""){r.set_prompt(f)}else if(e.which==13){if(n.length>0){d=true;o=0;g=n;v=E(0)}return false}}},prompt:f})},completion:function(e,n){var t=this.get_command();var i=this.login_name();var a;if(i=="guest"){a=y.settings.guest_commands}else{a=(y.dir.execs||[]).concat(h.executables)}function o(e){return(e.dirs||[]).map(function(e){return e+"/"})}function s(n){if(e.match(/^"/)){return n.map(function(e){return'"'+e})}else{return n.map(function(e){return e.replace(/([() ])/g,"\\$1")})}}var c=$.terminal.parse_command(t);var f=new RegExp("^\\s*"+$.terminal.escape_regex(e));var l=y.token;if(e.match(/^\$/)){r.shell(l,"env","/")(function(e,r){n(r.output.split("\n").map(function(e){return"$"+e.split(/=/)[0]}))})}else if(t.match(f)||t===""){var u=Object.keys(y.commands);n(u.concat(a))}else{var p=e.match(/(.*)\/([^\/]+)/);var m;if(c.name=="cd"){if(p){m=y.cwd+"/"+p[1];r.dir(l,m)(function(e,r){var t=(r.dirs||[]).map(function(e){return p[1]+"/"+e+"/"});n(t)})}else{n(o(y.dir))}}else if(c.name=="jargon"){n(y.jargon)}else{if(p){m=y.cwd+"/"+p[1];r.dir(l,m)(function(e,r){var t=o(r);var i=(r.files||[]).concat(t).map(function(e){return p[1]+"/"+e});n(i)})}else{var d=(y.dir.files||[]).concat(o(y.dir));n(d)}}}},onPush:function(e,n){var r=y.formatters.slice().concat(n.formatters||[]);$.terminal.defaults.formatters=r;v.push(r)},onPop:function(e,n){v.pop();if(v.length>0){var r=v[v.length-1];$.terminal.defaults.formatters=r}},execRead:function(e,n,r){var t=$.extend({history:true,context:null,token:false},r);var i=y.terminal;var a=i.history();if(!t.history){a.disable()}var o=[];if(t.token){o.push(i.token())}(function r(){var a=e.shift();if(a){if(typeof a==="object"){if(a.mask===true){i.set_mask(true)}prompt=a.prompt}else{prompt=a}i.read(prompt,function(e){o.push(e);i.set_mask(false);r()})}else{n.apply(t.context,o)}})()},commands:{github:function(n,r,t){var i=new optparse.OptionParser([["-u","--username USER","owner of the repo"],["-r","--repo REPO","repo to open"]]);i.banner="Usage: github [options]";var a,o,s="master";i.on("username",function(e,n){a=n});i.on("repo",function(e,n){o=n});i.parse(n.args);var c="https://api.github.com/repos";var u;var p;function m(e,n){var r=c+"/"+a+"/"+o+"/contents/"+e;$.ajax({url:r,type:"GET",success:function(e){n({dirs:e.filter(function(e){return e.type=="dir"}),files:e.filter(function(e){return e.type=="file"})})},error:function(e,n,r){t.error(n+" "+r);l(t)}})}function h(e,n){var r="https://raw.githubusercontent.com/"+a+"/"+o+"/master/"+e;$.ajax({url:r,type:"GET",success:n,error:function(e){t.error("file not found");l(t)}})}function d(n){t.echo(n.dirs.map(function(n){return e.blue(n.name)}).concat(n.files.map(function(e){return e.name})).join("\n"))}function v(e,n){f(t);h(g+e,function(e){n(e);l(t)})}if(a&&o){var g="/";p=$.Deferred();m("",function(e){u=e;p.resolve()});t.push(function(e){var n=$.terminal.parse_command(e);if(n.name=="cd"){var r=n.args[0];if(n.args[0]==".."){r=g.replace(/[^\/]+\/$/,"")}else{r=(g=="/"?"":g)+n.args[0]}f(t);p=$.Deferred();m(r,function(e){u=e;g=r;if(!g.match(/\/$/)){g+="/"}l(t);p.resolve()})}else if(n.name=="less"){v(n.args[0],y.less)}else if(n.name=="cat"){v(n.args[0],t.echo)}else if(n.name=="ls"){if(n.args==0){d(u)}else{f(t);m(n.args[0],function(e){d(e);l(t)})}}else{t.echo("unknown command "+n.name)}},{prompt:function(n){var r=e.green(a+"&#64;"+o);var t=g;if(t!="/"){t="/"+t.replace(/\/$/,"")}n(r+e.grey(":")+e.blue(t)+"$ ")},name:"github",completion:function(e,n){var r=$.terminal.parse_command(this.get_command());var t=e.match(/(.*)\/([^\/]+)/);if(t){m(t[1],function(e){if(r.name=="cd"){n(e.dirs.map(function(e){return t[1]+"/"+e.name+"/"}))}else{n(e.files.map(function(e){return t[1]+"/"+e.name+"/"}).concat(e.dirs.map(function(e){return t[1]+"/"+e.name})))}})}else{p.then(function(){if(r.name=="cd"){n(u.dirs.map(function(e){return e.name+"/"}))}else{n(u.files.map(function(e){return e.name}).concat(u.dirs.map(function(e){return e.name+"/"})))}})}}})}else{t.echo(i)}},download:function(e,n,r){if(e.args.length==1){var t=y.cwd+"/"+e.args[0];var i=$("<iframe/>").hide().appendTo("body");i.load(function(){i.remove()});var a=$.param({filename:t,token:n});i.attr("src","lib/download.php?"+a)}else{r.echo("usage: download {FILENAME}")}},pushd:function(e,n,r){if(e.args.length==1){var t=y.cwd;if(_.length==0){_.push(t)}y.shell("cd "+e.args[0],n,r).then(function(){_.push(y.cwd);r.echo(_.slice().reverse().join(" "))})}else{r.echo("usage: pushd {DIRECTORY}")}},popd:function(e,n,r){if(_.length>1){_.pop();var t=_[_.length-1];y.shell("cd "+t,n,r).then(function(){r.echo(_.slice().reverse().join(" "))})}else{r.echo("popd: directory stack empty");_=[]}},update:function(e,n,r){y.animation.start(400);y.service.update(n)(function(e,n){if(e){I(e)}else if(n){r.echo("[[;#ff0;]Leash updated, you can now refresh "+"the browser]")}else{r.error("No new version available")}y.animation.stop()})},rfc:function(e,n,r){var t=e.args.length?e.args[0]:null;f(r);y.service.rfc(t)(function(e,n){if(e){I(e)}else{y.less(n.replace(/^[\s\n]+|[\s\n]+$/g,""))}l(r)})},cat:function(e,n,t){if(e.command.match(/cat\s*$/)){t.push(function(e){t.echo(e)},{prompt:""})}else if(e.command.match(/cat\s*>+\s*\w+/)){var i="";var a=e.args[e.args.length-1];if(!a.match(/^\//)){a=y.cwd+"/"+a}t.push(function(e){i+=e+"\n"},{prompt:"",onExit:function(){if(e.args[0].match(/>>/)){r.append(n,a,i)(function(e,n){if(!n){t.error("Can't save file")}})}else{r.write(n,a,i)(function(e,n){if(!n){t.error("Can't save file")}})}},completion:[]})}else{y.shell(e.command,n,t)}},copyright:function(e,r,t){t.echo(n)},bzless:N("bzcat"),zless:N("zcat"),xzless:N("xzcat"),less:N("cat"),record:function(e,n,r){if(e.args[0]=="start"){r.history_state(true)}else if(e.args[0]=="stop"){r.history_state(false)}else{r.echo("usage: record [stop|start]")}},timer:function(e,n,r){function t(){r.echo("usage: timer time [command]\ntime - number [smh]")}if(e.args.length>1){var i=e.args[0];var a=i.match(/^([0-9.]+)([smh])$/);if(a){var o=e.rest.trim().replace(/^[0-9.]+[smh]?/,"");i=parseFloat(a[1]);switch(a[2]){case"h":i*=24;case"m":i*=60;case"s":i*=1e3}f(r);setTimeout(function(){y.interpreter(o,r)},i)}else{t()}}else{t()}},passwd:function(e,n,t){t.set_mask(true).history().disable();t.push(function(e){t.push(function(i){f(t);r.valid_password(n,e)(function(e,a){if(a){r.change_password(n,i)(function(e){if(!e){t.echo("Password successfully changed")}else{t.error(e.message)}t.pop().pop();l(t);t.set_mask(false).history().enable()})}else{t.error("Current password is not valid");t.pop().pop();l(t);t.set_mask(false).history().enable()}})},{prompt:"new password: ",name:"passwd_2",keydown:function(e){if(e.which==68&&e.ctrlKey){t.pop().pop().echo("new password: ");t.set_mask(false).history().enable();return false}}})},{prompt:"current password: ",name:"passwd_1"})},rpc:function(e,n,t){var i=e.args[0]||"",a;if(i===""){a=function(e,n){n(Object.keys(r))}}else{var o=$.Deferred();$.jrpc(i,"system.describe",[],function(e){o.resolve(e.procs.map(function(e){return e.name}))},function(e,n,r){t.error("[AJAX]: "+n);l(t);if(n=="Invalid JSON"){t.error(e.responseText)}o.reject()});a=function(e,n){o.then(n).fail(function(){n([])})}}t.push(function(e){var n=$.terminal.parse_command(T(e));f(t);$.jrpc(i,n.name,n.args,function(e){if(e.error){if(e.error.error){var n=e.error.error;var r=n.file.replace(h.home,"");t.error(n.message+" in "+r+" at "+n.at);t.error(n.line)}else if(e.error.message){t.error(e.error.message)}}else{t.echo(JSON.stringify(e.result))}l(t)},function(e,n,r){t.error("[AJAX]: "+n);l(t);if(n=="Invalid JSON"){t.error(e.responseText)}})},{name:"rpc",prompt:"rpc> ",completion:a})},wikipedia:function(e,n,r){function t(n){var r=$.Deferred();$.ajax({url:a,data:{action:"query",prop:"revisions",rvprop:"content",format:"json",titles:e.rest},dataType:"jsonp",success:function(t){var i=t.query.pages;var a=Object.keys(i).map(function(e){var n=i[e];if(n.revisions){return n.revisions[0]["*"]}else if(typeof n.missing!="undefined"){return"Article Not Found"}}).join("\n");a=y.wikipedia(a,e.rest);if($.isFunction(n)){n(a)}r.resolve(a)}});return r.promise()}function i(){w.pop();if(!w.length){r.option("convertLinks",true)}}if(e.args.length===0){r.echo("Display contents of wikipedia articles\n"+"usage: wikipedia [{ARTICLE} |-s {TERM}]\n\n"+"-s {SEARCH TERM}")}else{f(r);r.option("convertLinks",false);var a="https://en.wikipedia.org/w/api.php?";w.push(e.rest.replace(/^-s\s*/,""));if(e.rest.match(/^-s\s*/)){$.ajax({url:a,data:{action:"opensearch",format:"json",limit:100,search:e.rest.replace(/^-s\s*/,"")},dataType:"jsonp",success:function(e){if(e[1].length&&e[2].length){var n=e[1].map(function(n,r){return"[[bu;#fff;;wiki]"+n+"]\n"+e[2][r]}).join("\n\n");y.less(n,i);l(r)}}})}else if(e.rest.match(/^Category:/)){$.ajax({url:a,data:{action:"query",list:"categorymembers",rvprop:"content",format:"json",cmlimit:500,cmtitle:e.rest},dataType:"jsonp",success:function(e){var n=e.query.categorymembers;var a=n.map(function(e){return"[[bu;#fff;;wiki]"+e.title+"]"}).join("\n");var o=/(\[\[bu;#fff;;wiki\]Category)/;t(function(e){a=e.replace(o,a+"\n\n$1");y.less(a,i);l(r)})}})}else{t(function(e){y.less(function(n,r){var t=$.terminal.split_equal(e,n,true);r(t)},i);l(r)})}}},jargon:function(e,n,t){if(!e.args.length){var i="This is the Jargon File, a comprehensiv"+"e compendium of hacker slang illuminating man"+"y aspects of hackish tradition, folklore, and"+" humor.\n\nusage: jargon [-s] [QUERY]\n\n-s s"+"earch jargon file";t.echo(i,{keepWords:true})}else if(e.args[0]=="-s"){f(t);var a=e.rest.replace(/^-s/,"").trim();if(!a.match(/%/)){a="%"+a+"%"}y.service.jargon_search(a)(function(e,n){if(e){I(e)}else{t.echo(n.map(function(e){return"[[bu;#fff;;jargon]"+e.term+"]"}).join("\n"))}l(t)})}else{f(t);var o=e.args.join(" ").replace(/\s+/g," ");r.jargon(o)(function(e,n){if(e){I(e)}else{var r=$.map(n,function(e){var n="[[b;#fff;]"+e.term+"]";if(e.abbr){n+=" ("+e.abbr.join(", ")+")"}var r=new RegExp("((?:https?|ftps?)://\\S+)|"+"\\.(?!\\s|\\]\\s)\\)?","g");var t=e.def.replace(r,function(e,n){return n?n:e==".)"?".) ":". "});r=/\[(?![^;\]]*;[^;\]]*;[^\]]*\])[^\]]+\]/g;t=t.replace(r,function(e){return e.replace(/\]/g,"\\]")});return n+"\n"+t+"\n"}).join("\n");t.echo(r.replace(/\n$/,""),{keepWords:true})}l(t)})}},man:function(e,n,t){if(e.args.length===0){t.echo("usage: man {COMMAND}")}else{f(t);var i="MANWIDTH="+t.cols()+" "+e.command;r.shell(n,i,"/")(function(e,n){y.less($.terminal.overtyping(n.output));l(t)})}},sqlite:function(e,n,r){f(r);var t;if(!e.args.length){r.error("You need to provide the file");l(r);return}if(e.args[0].match(/^\//)){t=e.args[0]}else{t=y.cwd+"/"+e.args[0]}function i(e){var i=a();r.push(function(e){if(e.match(/^\s*help\s*$/)){r.echo("show tables:\n\tSELECT name FROM sqlite_m"+'aster WHERE type = "table"\ndescribe tabl'+"e:\n\tPRAGMA table_info([TABLE NAME])")}else{f(r);y.service.sqlite_query(n,t,e)(R)}},{name:"sqlite",prompt:"sqlite> ",completion:["help"].concat(i).concat(e),formatters:[o(i,e,"white")]})}var s='SELECT name FROM sqlite_master WHERE type = "table"';y.service.sqlite_query(n,t,s)(function(e,n){if(e){r.error(e.message)}else{i(n.map(function(e){return e["name"]}))}l(r)})},mysql:function(e,n,t){var a,s,c,u;var p=new optparse.OptionParser([["-h","--host HOST","Host to connect to"],["-u","--username USER","Database user"],["-p","--password PASSWORD","Database password"]]);var m=[];for(var h=0;h<e.args.length;++h){var d=e.args[h].match(/^(-[a-z])(.*)/);if(d){m.push(d[1]);if(d[2]){m.push(d[2])}else if(d[1]=="-p"){m.push("")}}else{m.push(e.args[h])}}p.on(0,function(e){a=e});p.on("host",function(e,n){s=n});p.on("username",function(e,n){c=n});p.on("password",function(e,n){u=n});p.banner="Usage: mysql [Options] database";p.parse(m);if(!(a&&c)){t.echo(p);return}s=s||"localhost";function v(){f(t);var e;function p(i){f(t);r.mysql_query(n,e,i)(R)}function m(e){r.mysql_close(n,e)(function(){var n=v().filter(function(n){return n!=e});g(n)})}var h="[[b;#55f;]mysql]> ";function d(n,r){r=$.map(r,function(e){return Object.keys(e).map(function(n){return e[n]})});var a=i();t.push(p,{prompt:h,name:"mysql",onExit:function(){m(e)},completion:a.concat(r),formatters:[o(a,r,"white")]});l(t)}function v(){var e;try{e=JSON.parse($.Storage.get("leash_mysql"))}catch(n){e=[]}return e}function g(e){$.Storage.set("leash_mysql",JSON.stringify(e))}v().forEach(function(e){m(e)});r.mysql_connect(n,s,c,u,a)(function(i,a){if(i){I(i);l(t)}else{e=a;var o=v();o.push(e);g(o);r.mysql_query(n,e,"show tables")(d)}})}if(!u){t.history().disable();t.push(function(e){u=e;t.pop().history().enable();v()},{prompt:"password: "}).set_mask("")}else{v()}},js:function(e,n,r){r.push(function(e,n){if(e!==undefined&&e!==""){try{var r=window.eval(e);if(r!==undefined){n.echo(new String(r))}}catch(e){n.error(new String(e))}}},{prompt:"[[;#D72424;]js]> ",name:"js"})},python:function(e,n,r){if(e.args.length){y.shell(e.command,n,r);return}var t="cgi-bin/python.py?token="+n;s(r,t,function(e){var n="";var t="Type help() for interactive help,"+" or help(object) for help about object.";r.push(function(i){if(i.match(/help/)){if(i.match(/^help *$/)){r.echo(t)}else{var a=/help\((.*)\)/;e.evaluate(i.replace(a,"print $1."+"__doc__"))}}else if(i.match(/:\s*$/)){n+=i+"\n";r.set_prompt("... ")}else if(n){if(i===""){r.set_prompt(">>> ");e.evaluate(n);n=""}else{n+=i+"\n"}}else{e.evaluate(i)}},{name:"python",prompt:">>> ",completion:false,onExit:function(){e.destroy()}})})},history:function(e,n,r){r.echo(r.history().data().join("\n"))},su:function(e,n,t){var i=new optparse.OptionParser([["-u","--user USER","User or root if not specified"]]);var a="root";i.on("user",function(e,n){a=n});i.parse(e.args);var o=function(){var e=t.level();return function n(){if(t.level()==e+1){t.logout()}}}();function s(e){var n,r;if(h&&h.server){n=h.server}else{n="unknown"}if(h&&y.cwd&&h.home!="/"){var t=$.terminal.escape_regex(h.home);var i=new RegExp("^"+t);r=y.cwd.replace(i,"~")}else{r=y.cwd}a=a||$.terminal.active().login_name();e(c(a,n,r))}t.history().disable();function u(e){var n=arguments.length==2;f(t);r.login(a,e)(function(e,r){t.history().enable();if(n){t.pop().set_mask(false)}if(e){t.error(e.message)}else if(r){E.push(y.cwd);g.push(y.make_interpreter(r));t.push(y.interpreter,{prompt:s,name:"su_"+a,onExit:function(){y.cwd=E.pop();g.pop();y.env.TOKEN=t.token(true);$(window).off("unload",o)}});t.set_token(r)}else{t.error("Wrong password")}l(t)});$(window).unload(o)}t.set_mask(true).push(u,{prompt:"password: "})},adduser:function(e,n,t){var i={prompt:"password: ",mask:true};var a=["user: ",i,"home: "];function o(e,n,i,a){r.add_user(e,n,i,a)(function(e){if(e){t.error(e.message)}else{t.echo("user "+n+" added to leash")}})}y.execRead(a,o,{history:false,token:true})},deluser:function(e,n,t){if(e.args.length!=1){t.echo("remove leash user\nusage:\ndeluser [username]")}else{var i=e.args[0];function a(e){if(e){I(e)}else{t.echo("user "+i+" removed")}}t.push(function(e){if(e.match(/^(y(es)?|n(o)?)$/i)){if(e.match(/^y/i)){r.remove_user(n,i)(a)}t.pop()}},{prompt:"Are you sure you want to delete this"+" account (Y/N)? "})}},purge:function(e,n,r){r.logout().purge()},help:function(e,n,r){function t(e){e=e.map(function(e){return"[[b;#fff;]"+e+"]"});if(e.length==0){return""}else if(e.length==1){return e[0]}return e.slice(0,-1).join(", ")+" and "+e[e.length-1]}r.echo("leash build in commands: "+t(Object.keys(y.commands)),{keepWords:true});r.echo("all other commands are exectute by the shell");if(y.settings.guest_commands.length){r.echo("guest users can only exeucte: "+t(y.settings.guest_commands))}else{r.echo("guest users can't execute any commands")}},grab:function(e,n,r){if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){var t=navigator.mediaDevices.getUserMedia({video:true});t.then(function(e){var n=e.getVideoTracks()[0];var r=new ImageCapture(n);return r.takePhoto()}).then(function(n){var t=new optparse.OptionParser([["-u","--upload FILENAME","filename to upload to the server"],["-h","--help","Display help screen"]]);var i;t.on("upload",function(e,n){i=n});var a;t.on("help",function(){a=true});t.parse(e.args);if(a){r.echo(t)}else if(i){var o=new Uploader(y);var s=new File([n],i);o.upload(s,y.cwd).then(function(){r.echo("uploaded to "+y.cwd)})}else{var c=URL.createObjectURL(n);r.echo('<img src="'+c+'"/>',{raw:true,finialize:function(e){e.find("img").on("load",function(){URL.revokeObjectURL(this.src)})}})}}).catch(function(e){r.error("Device Media Error: "+e)})}else{r.error("Image capture API don't supported by this device")}}}};r.installed()(function(e,n){y.installed=n;if(n){var i;y.greetings=y.banner();y.prompt=function(e){var n,r;if(h&&h.server){n=h.server}else{n="unknown"}if(h&&y.cwd&&h.home!="/"){var t=$.terminal.escape_regex(h.home);var a=new RegExp("^"+t);r=y.cwd.replace(a,"~")}else{r=y.cwd}i=i||$.terminal.active().login_name();e(c(i,n,r))};y.onImport=function(e){y.cwd=e.cwd;y.dir=e.dir;y.terminal.set_prompt(y.prompt)};y.onExport=function(){return{cwd:y.cwd,dir:y.dir}};y.set_login=function(e){i=e};y.login=function(e,n,a){m[t]=a;var o=this;o.pause();r.login(e,n)(function(n,r){m[t]=null;i=e;y.token=r;if(r&&typeof sysend!="undefined"){sysend.broadcast("leash.login",{user:e,token:r})}a(r);if(!r){o.resume()}})}}else{y.prompt="> ";y.login=false;y.greetings=null}u.resolve(y)})}var p=0;var m={};return function(e){var n=new $.Deferred;var r=p++;if(e.service){$.when(e.service).then(function(e){u(e,r,n)})}else{rpc({url:e.url||"",error:function(e){console.log(e);try{e=JSON.parse(e)}catch(e){}var n;if(e.error){e=e.error;n=e.message+" in "+e.file+"\n["+e.at+"] "+e.line}else{n=e.message||e}var t=$.terminal.active();if(t){t.error(n);t.leash().then(function(e){e.animation.stop();l(t)})}else{alert(n)}if(m[r]){m[r](null,true)}},debug:function(e,n){var r=n=="request"?"->":"<-"}})(function(e){u(e,p,n)})}return n.promise()}}();(function(e){e.fn.leash=function(n){if(!e.terminal||!e.fn.terminal){throw new Error("You need to include jQuery terminal to use leash")}if(this.data("leash")){return this.data("leash")}var r=e.extend({},{disable:[],url:"",service:null},n&&n.leash||{});var t=e.Deferred();var i=this.length;var a=[];this.each(function(o){var s=e(this);var c=leash(r);s.data("leash",c);c.then(function(c){if(r.disable.length){r.disable.forEach(function(e){delete c.commands[e]})}var f={onInit:c.init,completion:c.completion,linksNoReferrer:true,execHash:true,historyFilter:/^[^\s]/,onBeforeLogout:function(e){var n=e.token();if(n){c.service.logout(n)(function(){if(typeof sysend!="undefined"){sysend.broadcast("leash.logout")}})}},prompt:c.prompt,login:c.login,onExport:c.onExport,onImport:c.onImport,onPop:c.onPop,onPush:c.onPush,extra:{formatters:c.formatters},name:"leash",outputLimit:500,greetings:c.greetings,keypress:function(e){if(c.animation.animating){if(e.which==68&&e.ctrlKey){c.animation.stop()}return false}}};var l=e.extend(f,n||{});var u=s.terminal(c.interpreter,l);c.terminal=u;u.on("drop",function(e){e.preventDefault();var n=e.originalEvent;if(!u.token()){return}var r=new Uploader(c);var t;if(n.dataTransfer.items){t=[].slice.call(n.dataTransfer.items)}var i=n.dataTransfer.files||n.target.files;if(i){i=[].slice.call(i)}function a(){c.refresh_dir()}if(t&&t.length){if(t[0].webkitGetAsEntry){var o=[];t.forEach(function(e){var n=e.webkitGetAsEntry();if(n)o.push(n)});(function e(){var n=o.shift();if(n){r.upload_tree(n,c.cwd).then(e)}else{a()}})()}}else if(i&&i.length){(function e(){var n=i.shift();if(n){r.upload(n,c.cwd).then(e)}else{a()}})()}else if(n.dataTransfer.getFilesAndDirectories){n.dataTransfer.getFilesAndDirectories().then(function(e){(function n(){var t=e.shift();if(t){r.upload_tree(t,c.cwd).then(n)}else{a()}})()})}}).on("dragover",function(e){e.preventDefault()}).on("dragenter",function(e){e.preventDefault()});if(typeof sysend!="undefined"){sysend.on("leash.logout",function(){c.prompt(function(e){u.echo(e)});u.logout()});sysend.on("leash.login",function(e){u.autologin(e.user,e.token);c.set_login(e.user)})}a.push(c);if(i-1==o){t.resolve.apply(t,a)}})});return t.promise()}})(jQuery);